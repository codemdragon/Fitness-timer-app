<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fixed Sequence Timer</title>
    <style>
        :root {
            --bg: #000000;
            --surface: #1c1c1e;
            --primary: #0a84ff; /* Blue */
            --active: #30d158;  /* Green */
            --text: #ffffff;
            --dim: #8e8e93;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling the whole page */
        }

        /* Top Section: The Big Clock */
        .clock-display {
            flex: 1; /* Takes up available top space */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg);
            border-bottom: 1px solid #333;
            z-index: 10;
        }

        #timer-name {
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--dim);
            margin-bottom: 5px;
        }

        #timer-count {
            font-size: 6rem;
            font-weight: 800;
            font-variant-numeric: tabular-nums; /* Keeps numbers same width */
            line-height: 1;
        }

        /* Middle Section: The Scrollable List */
        .queue-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px; /* Space for buttons */
        }

        .timer-row {
            display: flex;
            align-items: center;
            background: var(--surface);
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        /* Highlight the currently running timer */
        .timer-row.active-row {
            border-color: var(--active);
            background: #152e1b; /* Dark green tint */
        }

        .row-inputs {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        input {
            background: transparent;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
        }

        .name-input { flex: 2; }
        .time-input { flex: 1; text-align: center; }

        .btn-delete {
            background: #ff453a;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-left: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Bottom Section: Controls */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border-top: 1px solid #333;
        }

        button.ctrl-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
        }

        #btn-add { background: var(--surface); color: var(--primary); }
        #btn-action { background: var(--active); color: #000; }
        
        .paused #btn-action { background: orange; }

    </style>
</head>
<body>

    <div class="clock-display">
        <div id="timer-name">Ready</div>
        <div id="timer-count">00:00</div>
    </div>

    <div class="queue-list" id="queue">
        </div>

    <div class="controls">
        <button id="btn-add" class="ctrl-btn" onclick="addTimer()">+ Add Step</button>
        <button id="btn-action" class="ctrl-btn" onclick="toggleTimer()">START</button>
    </div>

    <script>
        // -- DATA --
        // Default timers
        let playlist = [
            { id: 1, name: "Get Ready", seconds: 5 },
            { id: 2, name: "Work", seconds: 10 },
            { id: 3, name: "Rest", seconds: 5 }
        ];

        let currentIndex = 0;   // Which timer in the array are we on?
        let timeLeft = 0;       // Seconds remaining on current timer
        let intervalId = null;  // The JS Interval ID
        let audioCtx = null;    // For the beep

        // -- DOM ELEMENTS --
        const queueContainer = document.getElementById('queue');
        const displayCount = document.getElementById('timer-count');
        const displayName = document.getElementById('timer-name');
        const actionBtn = document.getElementById('btn-action');

        // -- INITIAL RENDER --
        renderList();
        resetToStart();

        // -- CORE LOGIC --

        function toggleTimer() {
            if (intervalId) {
                pause();
            } else {
                start();
            }
        }

        function start() {
            // Init Audio Context on first user click (Mobile requirement)
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            actionBtn.textContent = "PAUSE";
            document.body.classList.add('paused'); 
            
            // If we are completely fresh or finished, reset to index 0
            if (currentIndex >= playlist.length) {
                currentIndex = 0;
                timeLeft = playlist[0].seconds;
            }

            intervalId = setInterval(() => {
                // THE FIX: Check if we are done BEFORE subtracting
                if (timeLeft <= 0) {
                    nextTimer();
                } else {
                    timeLeft--;
                    updateDisplay();
                }
            }, 1000);
        }

        function pause() {
            clearInterval(intervalId);
            intervalId = null;
            actionBtn.textContent = "RESUME";
            document.body.classList.remove('paused');
        }

        function nextTimer() {
            // Play Beep
            playBeep();

            // Move to next
            currentIndex++;

            // Check if there is a next timer
            if (currentIndex < playlist.length) {
                // Yes: Set time, highlight row, keep going
                timeLeft = playlist[currentIndex].seconds;
                updateDisplay();
                highlightActiveRow();
                // Scroll the list so the active one is visible
                document.querySelector('.active-row')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                // No: We are done
                finish();
            }
        }

        function finish() {
            pause();
            playBeep(440); // Lower pitch finish beep
            setTimeout(() => playBeep(440), 200); // Double beep
            
            displayName.textContent = "COMPLETED";
            displayName.style.color = "var(--active)";
            displayCount.textContent = "DONE";
            actionBtn.textContent = "RESTART";
            currentIndex = 0; // Reset for next time
        }

        function resetToStart() {
            currentIndex = 0;
            // Grab the first timer's seconds if it exists
            if (playlist.length > 0) {
                timeLeft = playlist[0].seconds;
                displayName.textContent = playlist[0].name;
                displayName.style.color = "var(--dim)";
            } else {
                timeLeft = 0;
                displayName.textContent = "Empty";
            }
            updateDisplay();
            highlightActiveRow();
        }

        // -- DISPLAY HELPERS --

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            displayCount.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            if (playlist[currentIndex]) {
                displayName.textContent = playlist[currentIndex].name;
            }
        }

        function highlightActiveRow() {
            // Remove active class from all
            document.querySelectorAll('.timer-row').forEach(row => row.classList.remove('active-row'));
            
            // Add to current index
            const rows = document.querySelectorAll('.timer-row');
            if (rows[currentIndex]) {
                rows[currentIndex].classList.add('active-row');
            }
        }

        // -- LIST MANAGEMENT --

        function renderList() {
            queueContainer.innerHTML = '';
            playlist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'timer-row';
                if (index === currentIndex && intervalId) div.classList.add('active-row');
                
                div.innerHTML = `
                    <div class="row-inputs">
                        <input type="text" class="name-input" value="${item.name}" onchange="updateData(${index}, 'name', this.value)">
                        <input type="number" class="time-input" value="${item.seconds}" onchange="updateData(${index}, 'seconds', this.value)">
                    </div>
                    <button class="btn-delete" onclick="removeTimer(${index})">âœ•</button>
                `;
                queueContainer.appendChild(div);
            });
            highlightActiveRow();
        }

        function addTimer() {
            playlist.push({ 
                id: Date.now(), 
                name: "Exercise", 
                seconds: 30 
            });
            renderList();
            // If the list was empty, we need to update the big display immediately
            if (playlist.length === 1) resetToStart();
        }

        function removeTimer(index) {
            playlist.splice(index, 1);
            renderList();
            // If we deleted the current running timer, reset
            if (index === currentIndex) {
                pause();
                resetToStart();
            }
        }

        function updateData(index, field, value) {
            if (field === 'seconds') value = parseInt(value);
            playlist[index][field] = value;
            
            // If we edited the *current* timer while it's paused or waiting, update the big display
            if (index === currentIndex && !intervalId) {
                timeLeft = playlist[currentIndex].seconds;
                updateDisplay();
            }
        }

        // -- SOUND --
        function playBeep(freq = 800) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = "sine";
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

    </script>
</body>
</html>
